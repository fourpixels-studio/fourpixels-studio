{% extends 'base.html' %}
{% block body %}
{% load static %}
<main class="container pb-5 px-3 mb-5">
    <header class="row my-4 mt-lg-5">
        <div class="col-sm-12 col-md-7">
            <a href="{% url 'applications_list' %}" onclick="if (document.referrer && document.referrer !== window.location.href) { history.back(); return false; }" class="no-link"><i class="fa-solid fa-arrow-left me-2"></i> Applications</a>
            <h1 class="display-5 mt-2">Free QR Code Generator</h1>
            <p class="mb-0">This tool that helps you create a QR code for your website, social media or even business cards.</p>
        </div>
    </header>
    <section class="row justify-content-between align-items-start">
        <form id="qrForm" method="POST" onsubmit="showSpinner()" class="col-sm-12 col-lg-6">
            {% csrf_token %}
            <div class="mb-3">
                <label for="qr_name" class="mb-1 text-muted">Name</label>
                <input type="text" class="form-control" id="qr_name" name="qr_name" placeholder="e.g. My first QR code" required>
            </div>
            <div class="mb-3">
                <label for="qr_input"  class="mb-1 text-muted">Enter the URL to which the QR code will link</label>
                <input type="text" class="form-control" id="qr_input" name="qr_input" placeholder="e.g. www.mywebsite.com" required>
            </div>
            <button id="submit-btn" type="submit" class="btn btn-dark w-100 rounded-3 mt-4 py-2 px-4 btn-lg">
                <span id="submit-text">Generate</span>
                <span id="processing-text" class="d-none">Generating...</span>
                <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            </button>
        </form>
        <div class="col-lg-5 text-center d-none d-lg-block">
            <img src="{% static 'four-pixels-studio-instagram-qr.png' %}" alt="" class="img-fluid" style="margin-top: -8rem;">
        </div>
        <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalTitle" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content border-0 bg-light">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="qrModalTitle">QR Code</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center" id="qrModalBody"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary px-4 py-2" data-bs-dismiss="modal">Close</button>
                        <a href="#" id="qrDownloadButton" class="btn btn-primary px-4 py-2">Download</a>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
<script>
document.querySelector('#qrForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent the default form submission

    const formData = new FormData(this); // Collect form data
    const modalTitle = document.querySelector('#qrModalTitle');
    const modalBody = document.querySelector('#qrModalBody');
    const modalDownloadButton = document.querySelector('#qrDownloadButton');

    // Send AJAX request
    fetch("{% url 'qr_code_generator' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.qr_code_image) {
            // Update the modal title and image
            modalTitle.textContent = data.qr_name;
            modalBody.innerHTML = `<img src="data:image/png;base64,${data.qr_code_image}" alt="QR Code" class="img-fluid mt-3 border">`;

            // Update the download button link
            modalDownloadButton.href = data.download_url;

            // Show the modal
            const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
            qrModal.show();

            const submitBtn = document.getElementById('submit-btn');
            document.getElementById('submit-text').classList.remove('d-none');
            document.getElementById('processing-text').classList.add('d-none');
            submitBtn.disabled = false;
            document.getElementById('spinner').classList.add('d-none');

        } else {
            alert("Failed to generate QR code.");
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("An error occurred while generating the QR code.");
    });
});
</script>

{% endblock %}